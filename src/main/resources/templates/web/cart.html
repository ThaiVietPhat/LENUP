<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giỏ hàng</title>
<!-- Bootstrap 5 -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" th:href="@{/css/footer-chatbox-backtotop.css}">
<link rel="stylesheet" th:href="@{/css/cart.css}">
<link rel="stylesheet" th:href="@{/css/header.css}">
</head>
<body>
	<!-- Header -->
	<div th:replace="fragments/header :: siteHeader"></div>

	<div class="cart-container pb-2 pt-2">
		<div class="container">
			<h2 class="text-center mb-4">Giỏ hàng của bạn</h2>
			<div th:if="${error}" class="alert alert-danger text-center"
				role="alert" th:text="${error}"></div>
			<div th:if="${success}" class="alert alert-success text-center"
				role="alert" th:text="${success}"></div>

			<div class="card cart-card shadow-sm">
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-hover align-middle"
							th:if="${not #lists.isEmpty(cartItems)}">
							<thead class="table-light text-center">
								<tr>
									<th>Hình ảnh</th>
									<th>Tên sản phẩm</th>
									<th>Size</th>
									<th>Màu</th>
									<th>Giá</th>
									<th>Số lượng</th>
									<th>Tổng tiền</th>
									<th>Thao tác</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="item : ${cartItems}"
									class="text-center cart-item-row">
									<td><img th:src="@{${imageUrls[item.variant.id]}}"
										alt="Sản phẩm" class="img-thumbnail"
										style="width: 60px; height: 60px; object-fit: cover;"></td>
									<td th:text="${item.productName}" class="fw-medium text-dark"></td>
									<td th:text="${sizes[item.variant.id] ?: 'N/A'}"
										class="fw-medium text-dark"></td>
									<td th:text="${colors[item.variant.id] ?: 'N/A'}"
										class="fw-medium text-dark"></td>
									<td
										th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + ' VNĐ'}"
										class="text-danger fw-semibold"></td>
									<td>
										<form
											th:action="@{/cart/update/{variantId}(variantId=${item.variant.id})}"
											method="post" class="d-flex flex-column align-items-center">
											<input type="number" name="quantity"
												th:value="${item.quantity}"
												th:max="${stocks[item.variant.id]}" min="1"
												class="form-control text-center mb-2" style="width: 80px;"
												oninput="validateQuantity(this, ${stocks[item.variant.id]}, ${item.variant.id})">
											<button type="submit"
												class="btn btn-sm btn-outline-primary rounded-pill px-3">
												<i class="bi bi-arrow-repeat"></i> Cập nhật
											</button>
											<span class="error-message text-danger"
												id="error-${item.variant.id}" style="display: none;"></span>
										</form>
									</td>
									<td
										th:text="${#numbers.formatInteger(item.getTotalPrice(), 0, 'COMMA') + ' VNĐ'}"
										class="fw-semibold text-success"></td>
									<td>
										<form
											th:action="@{/cart/remove/{variantId}(variantId=${item.variant.id})}"
											method="post">
											<button type="submit"
												class="btn btn-sm btn-outline-danger rounded-pill px-3">
												<i class="bi bi-trash3"></i> Xóa
											</button>
										</form>
									</td>
								</tr>
							</tbody>
						</table>
						<div th:unless="${not #lists.isEmpty(cartItems)}"
							class="alert alert-info text-center" role="alert">Giỏ hàng
							của bạn đang trống.</div>
					</div>

					<div
						class="d-flex justify-content-between align-items-center mt-4 flex-column flex-md-row">
						<h4 class="text-danger fw-bold"
							th:if="${not #lists.isEmpty(cartItems)}">
							Tổng cộng: <span
								th:text="${#numbers.formatInteger(cartTotal, 0, 'COMMA') + ' VNĐ'}"></span>
						</h4>
						<a href="/cart/checkout"
							class="btn btn-custom btn-lg rounded-pill px-4 mt-3 mt-md-0"
							th:if="${not #lists.isEmpty(cartItems)}"> <i
							class="bi bi-credit-card"></i> Thanh toán
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Back to Top Button -->
		<button id="backToTop" title="Lên đầu trang">↑</button>

		<!-- Back to Top Button -->
		<button id="backToTop" title="Lên đầu trang">↑</button>
		<script src="https://app.tudongchat.com/js/chatbox.js"></script>
		<script>
			const tudong_chatbox = new TuDongChat('rcAWY0gPAIyrID6TbMt_5')
			tudong_chatbox.initial()
		</script>
		<div th:replace="fragments/footer :: siteFooter"></div>

		<!-- Bootstrap JS -->
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<!-- Custom JS -->
		<script th:src="@{/js/home.js}"></script>
		<script type="module" src="/js/main.js"></script>
		<script type="module" src="/js/chatbox.js"></script>
		<script type="module" src="/js/backtotop.js"></script>

		<script>
			function validateQuantity(input, maxStock, variantId) {
				const errorSpan = document.getElementById('error-' + variantId);
				const quantity = parseInt(input.value);

				if (quantity > maxStock) {
					errorSpan.textContent = 'Số lượng vượt quá tồn kho ('
							+ maxStock + ')!';
					errorSpan.style.display = 'block';
					input.value = maxStock; // Giới hạn số lượng tối đa
				} else if (quantity < 1) {
					errorSpan.textContent = 'Số lượng phải lớn hơn 0!';
					errorSpan.style.display = 'block';
					input.value = 1; // Đặt lại số lượng tối thiểu
				} else {
					errorSpan.style.display = 'none';
				}

				// Nếu không có lỗi, tự động submit form khi người dùng thay đổi hợp lệ
				if (errorSpan.style.display === 'none'
						&& quantity !== parseInt(input.getAttribute('value'))) {
					input.form.submit();
				}
			}
		</script>
</body>
</html>