<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${product.name}">Chi Tiết Sản Phẩm</title>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/productdetail.css}">
    <link rel="stylesheet" th:href="@{/css/footer-chatbox-backtotop.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <style>
        .variant-container { margin-bottom: 1.5rem; }
        .variant-label { font-weight: 600; margin-bottom: 0.5rem; }
        .variant-btn { margin: 0.25rem; border-radius: 0.25rem; transition: all 0.2s; }
        .variant-btn.active { border-color: #000; background-color: #000; color: #fff; }
        .variant-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .variant-btn:hover:not(:disabled) { background-color: #e9ecef; }
    </style>
</head>
<body>
    <!-- Header -->
    <div th:replace="fragments/header :: siteHeader"></div>

    <!-- Main Content -->
    <div class="container my-5" id="productContainer" th:data-product-id="${product.id}">
        <div class="row">
            <!-- Hình ảnh sản phẩm -->
            <div class="col-md-6">
                <div class="product-detail">
                    <img th:src="${images != null and !images.isEmpty() ? images[0].imageUrl : '/path/to/placeholder.jpg'}"
                         alt="Product Image" class="img-fluid rounded" id="mainImage">
                </div>

                <!-- Thumbnails Slideshow -->
                <div class="mt-3" th:if="${images != null and !images.isEmpty()}">
                    <div class="swiper thumbnail-slider">
                        <div class="swiper-wrapper">
                            <div class="swiper-slide" th:each="image, iterStat : ${images}">
                                <img th:src="${image.imageUrl}"
                                     th:classappend="${iterStat.index == 0 ? 'thumbnail-img active' : 'thumbnail-img'}"
                                     alt="Thumbnail" onclick="changeImage(this)">
                            </div>
                        </div>
                        <div class="swiper-button-prev thumbnail-prev"><i class="fas fa-chevron-left"></i></div>
                        <div class="swiper-button-next thumbnail-next"><i class="fas fa-chevron-right"></i></div>
                        <div class="swiper-pagination"></div>
                    </div>
                </div>

                <div class="alert alert-warning" th:if="${images == null or images.isEmpty()}">
                    <p>Không có hình ảnh cho sản phẩm này.</p>
                </div>
            </div>

            <!-- Thông tin sản phẩm -->
            <div class="col-md-6">
                <h3 th:text="${product.name}">Tên sản phẩm</h3>

                <strong class="text-danger product-price"
                        th:text="${variants != null and !variants.isEmpty() ? #numbers.formatDecimal(variants[0].price, 0, 'COMMA', 0, 'POINT') + ' VNĐ' : 'COMING SOON'}">
                    0 VNĐ
                </strong>

                <p class="product-description mt-3"
                   th:text="${product.description != null ? product.description : 'Không có mô tả'}"></p>

                <!-- Thông báo lỗi và thành công -->
                <div th:if="${error}" class="alert alert-danger mt-3" role="alert" th:text="${error}"></div>
                <div th:if="${success}" class="alert alert-success mt-3" role="alert" th:text="${success}"></div>

                <!-- Đã đăng nhập -->
                <form th:action="@{/cart/add}" method="POST" th:if="${session.user != null}">
                    <input type="hidden" name="productId" th:value="${product.id}"/>
                    <input type="hidden" id="variantId" name="variantId" value=""/>

                    <!-- Variant Selection (Size and Color) -->
                    <div class="variant-container" th:if="${sizes != null and !sizes.isEmpty()}">
                        <div class="variant-label">Kích thước:</div>
                        <div class="size-selection">
                            <button type="button" class="btn btn-outline-dark variant-btn"
                                    th:each="size : ${sizes}"
                                    th:text="${size}"
                                    th:attr="data-size=${size}"
                                    onclick="selectSize(this)"></button>
                        </div>
                    </div>

                    <div class="variant-container" th:if="${colors != null and !colors.isEmpty()}">
                        <div class="variant-label">Màu sắc:</div>
                        <div class="color-selection">
                            <button type="button" class="btn btn-outline-dark variant-btn"
                                    th:each="color : ${colors}"
                                    th:text="${color}"
                                    th:attr="data-color=${color}"
                                    onclick="selectColor(this)"></button>
                        </div>
                    </div>

                    <div class="mb-3" th:if="${variants != null and !variants.isEmpty()}">
                        <label for="quantity" class="form-label">Số lượng:</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required>
                    </div>

                    <!-- Hiển thị số lượng tồn kho -->
                    <div class="mb-3" th:if="${variants != null and !variants.isEmpty()}">
                        <label class="form-label">Kho:</label>
                        <span id="stockDisplay" class="text-muted">Chọn kích thước và màu sắc để xem số lượng tồn kho</span>
                    </div>

                    <button type="submit" class="btn btn-dark btn-lg mt-3"
                            th:disabled="${variants == null or variants.isEmpty()}" id="addToCartBtn">Thêm vào giỏ hàng</button>

                    <a th:href="@{/cart/add(productId=${product.id},variantId=${variants != null and !variants.isEmpty() ? variants[0].id : 0},quantity=1)}"
                       class="btn btn-danger btn-lg mt-3"
                       th:if="${variants != null and !variants.isEmpty()}" id="buyNowBtn">Mua ngay</a>
                </form>

                <!-- Chưa đăng nhập -->
                <div th:if="${session.user == null}">
                    <div class="variant-container" th:if="${sizes != null and !sizes.isEmpty()}">
                        <div class="variant-label">Kích thước:</div>
                        <div class="size-selection">
                            <button type="button" class="btn btn-outline-dark variant-btn"
                                    th:each="size : ${sizes}"
                                    th:text="${size}"
                                    th:attr="data-size=${size}"
                                    onclick="selectSize(this)"></button>
                        </div>
                    </div>

                    <div class="variant-container" th:if="${colors != null and !colors.isEmpty()}">
                        <div class="variant-label">Màu sắc:</div>
                        <div class="color-selection">
                            <button type="button" class="btn btn-outline-dark variant-btn"
                                    th:each="color : ${colors}"
                                    th:text="${color}"
                                    th:attr="data-color=${color}"
                                    onclick="selectColor(this)"></button>
                        </div>
                    </div>

                    <div class="mb-3" th:if="${variants != null and !variants.isEmpty()}">
                        <label for="quantity2" class="form-label">Số lượng:</label>
                        <input type="number" class="form-control" id="quantity2" name="quantity" value="1" min="1" required>
                    </div>

                    <div class="mb-3" th:if="${variants != null and !variants.isEmpty()}">
                        <label class="form-label">Kho:</label>
                        <span id="stockDisplay" class="text-muted">Chọn kích thước và màu sắc để xem số lượng</span>
                    </div>

                    <button class="btn btn-dark btn-lg mt-3" onclick="showLoginAlert()">Thêm vào giỏ hàng</button>
                    <button class="btn btn-danger btn-lg mt-3" onclick="showLoginAlert()">Mua ngay</button>
                </div>
            </div>
        </div>

        <!-- Sản phẩm liên quan -->
        <div class="container my-5">
            <h3 class="mb-4 text-center fw-bold">Sản Phẩm Cùng Loại</h3>

            <div class="related-products-slider" th:if="${relatedProducts != null and !relatedProducts.isEmpty()}">
                <div class="swiper related-products-swiper">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide" th:each="relatedProduct : ${relatedProducts}">
                            <div class="card h-100 shadow-sm border-0 rounded-3 product-card">
                                <a th:href="@{/product/detail/{id}(id=${relatedProduct.id})}" class="text-decoration-none text-dark">
                                    <img th:src="${relatedProductImages.get(relatedProduct.id)}" 
                                         class="card-img-top rounded-3" 
                                         alt="Related Product" 
                                         style="height: 200px; object-fit: cover;">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-truncate mb-2" th:text="${relatedProduct.name}">Sản phẩm</h6>
                                        <strong th:class="${relatedProductPrices.get(relatedProduct.id) == 'COMING SOON' ? 'coming-soon fs-5' : 'text-danger fs-5'}" 
                                                th:text="${relatedProductPrices.get(relatedProduct.id) == 'COMING SOON' ? 'COMING SOON' : relatedProductPrices.get(relatedProduct.id) + ' VND'}">
                                            0 VND
                                        </strong>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- Nút điều hướng -->
                    <div class="swiper-button-prev related-prev"></div>
                    <div class="swiper-button-next related-next"></div>
                    <!-- Phân trang -->
                    <div class="swiper-pagination related-pagination"></div>
                </div>
            </div>

            <div class="alert alert-info text-center" th:if="${relatedProducts == null or relatedProducts.isEmpty()}">
                <p>Không có sản phẩm liên quan.</p>
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTop" title="Lên đầu trang">↑</button>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: siteFooter}"></div>

    <!-- variant data (hidden) - JS sẽ đọc từ đây -->
    <div id="variantDataContainer" class="d-none">
        <div class="variant-data" th:each="variant : ${variants}"
             th:data-id="${variant.id}"
             th:data-size="${variant.size}"
             th:data-color="${variant.color}"
             th:data-price="${variant.price}"
             th:data-stock="${variant.stock}"></div>
    </div>


<script src="https://app.tudongchat.com/js/chatbox.js"></script>
<script>
  const tudong_chatbox = new TuDongChat('rcAWY0gPAIyrID6TbMt_5')
  tudong_chatbox.initial()
</script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Swiper JS -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module" src="/js/main.js"></script>

    <!-- Custom JS -->
    <script>
        // Read productId and build variants array from DOM dataset
        const productContainer = document.getElementById('productContainer');
        const productId = productContainer ? productContainer.dataset.productId : null;

        // Build variants array from hidden elements
        const variantNodes = document.querySelectorAll('.variant-data');
        const variants = Array.from(variantNodes).map(node => ({
            id: node.dataset.id || '',
            size: node.dataset.size || '',
            color: node.dataset.color || '',
            price: parseFloat(node.dataset.price || 0),
            stock: parseInt(node.dataset.stock || 0) // Thêm trường stock
        }));

        let selectedSize = null;
        let selectedColor = null;

        document.addEventListener('DOMContentLoaded', function () {
        	// Init thumbnail slider
            const thumbnailSlides = document.querySelectorAll('.thumbnail-slider .swiper-slide');
            const thumbnailSlider = document.querySelector('.thumbnail-slider');

            if (thumbnailSlides.length > 1) {
                try {
                    new Swiper('.thumbnail-slider', {
                        slidesPerView: 4,
                        spaceBetween: 10,
                        navigation: {
                            nextEl: '.thumbnail-next',
                            prevEl: '.thumbnail-prev',
                        },
                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true,
                        },
                        breakpoints: {
                            768: { slidesPerView: 3 },
                            576: { slidesPerView: 2 }
                        }
                    });
                } catch (error) {
                    console.error('Thumbnail Swiper init error:', error);
                }
            } else if (thumbnailSlides.length === 1) {
                thumbnailSlider.classList.add('single-image');
                const thumbnailImg = thumbnailSlides[0].querySelector('.thumbnail-img');
                if (thumbnailImg) {
                    thumbnailImg.classList.add('active');
                }
            }


            // Init related products slider
            const relatedSlides = document.querySelectorAll('.related-products-swiper .swiper-slide');
            if (relatedSlides.length > 0) {
                try {
                    new Swiper('.related-products-swiper', {
                        slidesPerView: 4,
                        spaceBetween: 20,
                        loop: relatedSlides.length > 4,
                        navigation: {
                            nextEl: '.related-next',
                            prevEl: '.related-prev',
                        },
                        pagination: {
                            el: '.related-pagination',
                            clickable: true,
                        },
                        breakpoints: {
                            1200: { slidesPerView: 4 },
                            768: { slidesPerView: 3 },
                            576: { slidesPerView: 2 },
                            0: { slidesPerView: 1 }
                        },
                        autoplay: {
                            delay: 4000,
                            disableOnInteraction: false,
                        }
                    });
                } catch (error) {
                    console.error('Related products Swiper init error:', error);
                }
            }

            // If only one variant exists, preselect it
            if (variants.length === 1) {
                selectedSize = variants[0].size || null;
                selectedColor = variants[0].color || null;
                document.querySelectorAll('.size-selection .variant-btn').forEach(btn => {
                    if (btn.dataset.size === selectedSize) btn.classList.add('active');
                });
                document.querySelectorAll('.color-selection .variant-btn').forEach(btn => {
                    if (btn.dataset.color === selectedColor) btn.classList.add('active');
                });
            }

            // Save initial price text
            const priceElement = document.querySelector('.product-price');
            const initialPriceText = priceElement ? priceElement.textContent : '';

            updateVariantAvailability(initialPriceText);

            // Show backToTop when scroll
            window.addEventListener('scroll', () => {
                const btn = document.getElementById('backToTop');
                if (window.scrollY > 300) btn.style.display = 'block'; else btn.style.display = 'none';
            });
            document.getElementById('backToTop').addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
        });

        function showLoginAlert() {
            alert("Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng!");
            window.location.href = "/login";
        }

        function changeImage(element) {
            document.getElementById('mainImage').src = element.src;
            document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
            element.classList.add('active');
        }

        function selectSize(element) {
            const size = element.getAttribute('data-size') || null;
            if (element.classList.contains('active')) {
                selectedSize = null;
                element.classList.remove('active');
            } else {
                selectedSize = size;
                document.querySelectorAll('.size-selection .variant-btn').forEach(btn => btn.classList.remove('active'));
                element.classList.add('active');
            }
            updateVariantAvailability();
        }

        function selectColor(element) {
            const color = element.getAttribute('data-color') || null;
            if (element.classList.contains('active')) {
                selectedColor = null;
                element.classList.remove('active');
            } else {
                selectedColor = color;
                document.querySelectorAll('.color-selection .variant-btn').forEach(btn => btn.classList.remove('active'));
                element.classList.add('active');
            }
            updateVariantAvailability();
        }

        function updateVariantAvailability(initialPriceText) {
            const addToCartBtn = document.getElementById('addToCartBtn');
            const buyNowBtn = document.getElementById('buyNowBtn');
            const variantIdInput = document.getElementById('variantId');
            const priceElement = document.querySelector('.product-price');
            const stockDisplay = document.getElementById('stockDisplay');
            const quantityInput = document.getElementById('quantity');

            // Enable/disable color buttons based on selectedSize
            document.querySelectorAll('.color-selection .variant-btn').forEach(btn => {
                const color = btn.dataset.color;
                btn.disabled = selectedSize && !variants.some(v => v.size === selectedSize && v.color === color);
            });

            // Enable/disable size buttons based on selectedColor
            document.querySelectorAll('.size-selection .variant-btn').forEach(btn => {
                const size = btn.dataset.size;
                btn.disabled = selectedColor && !variants.some(v => v.color === selectedColor && v.size === size);
            });

            // Find matching variants
            let matched = variants.slice();
            if (selectedSize) matched = matched.filter(v => v.size === selectedSize);
            if (selectedColor) matched = matched.filter(v => v.color === selectedColor);

            if (matched.length === 1) {
                const sv = matched[0];
                if (variantIdInput) variantIdInput.value = sv.id;
                if (priceElement) {
                    // Định dạng giá theo kiểu 179,000 VNĐ
                    const formattedPrice = sv.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' VNĐ';
                    priceElement.textContent = formattedPrice;
                }
                if (stockDisplay) stockDisplay.textContent = `Còn ${sv.stock} sản phẩm`;
                if (quantityInput) {
                    quantityInput.max = sv.stock; // Giới hạn số lượng tối đa bằng stock
                    if (parseInt(quantityInput.value) > sv.stock) {
                        quantityInput.value = sv.stock; // Đặt lại số lượng nếu vượt quá stock
                    }
                }
                if (addToCartBtn) addToCartBtn.disabled = false;
                if (buyNowBtn) buyNowBtn.href = '/cart/add?productId=' + productId + '&variantId=' + sv.id + '&quantity=1';
            } else {
                if (variantIdInput) variantIdInput.value = '';
                if (addToCartBtn) addToCartBtn.disabled = true;
                if (buyNowBtn) buyNowBtn.href = '#';
                if (priceElement && typeof initialPriceText !== 'undefined') {
                    priceElement.textContent = initialPriceText;
                }
                if (stockDisplay) stockDisplay.textContent = 'Chọn kích thước và màu sắc để xem số lượng';
                if (quantityInput) {
                    quantityInput.removeAttribute('max'); // Xóa giới hạn khi không có biến thể
                }
            }
        }
    </script>
</body>
</html>